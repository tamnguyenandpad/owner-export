(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[489],{721:function(e,t,n){(window.__NEXT_P=window.__NEXT_P||[]).push(["/shares/[shareId]/constructions/[constructionId]/message",function(){return n(4346)}])},2578:function(e,t,n){"use strict";var o=n(2322),s=n(2784),i=function(e){var t=e.fill;return(0,o.jsx)("svg",{width:"24",height:"25",viewBox:"0 0 24 25",fill:"none",xmlns:"http://www.w3.org/2000/svg",children:(0,o.jsx)("path",{d:"M23.71 1.29026C23.575 1.15593 23.4045 1.06293 23.2185 1.02218C23.0325 0.98144 22.8388 0.994649 22.66 1.06026L0.660001 9.06026C0.470269 9.13222 0.306921 9.26021 0.191652 9.42721C0.0763829 9.59422 0.0146484 9.79234 0.0146484 9.99526C0.0146484 10.1982 0.0763829 10.3963 0.191652 10.5633C0.306921 10.7303 0.470269 10.8583 0.660001 10.9303L9.25 14.3603L15.59 8.00026L17 9.41026L10.63 15.7803L14.07 24.3703C14.1441 24.5563 14.2724 24.7159 14.4382 24.8282C14.604 24.9405 14.7997 25.0005 15 25.0003C15.2021 24.9961 15.3982 24.9308 15.5624 24.813C15.7266 24.6952 15.8513 24.5304 15.92 24.3403L23.92 2.34026C23.9881 2.16333 24.0046 1.97069 23.9674 1.78478C23.9302 1.59887 23.8409 1.42737 23.71 1.29026Z",fill:t||"#EF3340"})})};t.Z=(0,s.memo)(i)},6651:function(e,t,n){"use strict";var o=n(2322),s=n(2784),i=n(917),r=n(6582),l=s.forwardRef((function(e,t){var n=e.id,l=e.name,a=e.defaultValue,d=e.readonly,c=e.disabled,u=e.placeholder,m=e.onChange,f=e.onBlur,h=e.onEnter,v=e.isDisableEnter,g=e.className,x=e.row,p=(0,s.useCallback)((function(e){"Enter"!==e.code||!h||e.shiftKey||v||(h(),!r.tq&&(0,i.t)())}),[v,h]);return(0,o.jsx)("textarea",{id:n,"data-testid":"input-ref",name:l,defaultValue:a,placeholder:u||"",ref:t,rows:x||1,onChange:m,onBlur:f,onKeyPress:p,readOnly:d||!1,disabled:c||!1,className:g||"bg-white rounded w-full py-2 px-4 text-grey-900 border border-blue-500"})}));t.Z=(0,s.memo)(l)},4346:function(e,t,n){"use strict";n.r(t),n.d(t,{default:function(){return ge}});var o=n(8788),s=n(6383),i=n(4776),r=n.n(i),l=n(2322),a=n(2784),d=n(7693),c=n(299),u=n(738),m=n(4082),f=n(7417),h=n(9328),v=n(9390),g=n(1187),x=n(4924),p=n(8654),b=n(5134),w=n(4823),j=n(3770),C=n(2595),y=function(e){var t=e.message,n=e.isMine,o=(0,a.useMemo)((function(){return(0,C.Z)(t)}),[t]);return(0,l.jsxs)("div",{className:"w-full",children:[(0,l.jsxs)(w.Z,{id:t.id,className:"rounded-lg mt-[4px] h-auto p-[20px] w-fit break-words max-w-full ".concat(n?"bg-blue-300 ml-auto":"bg-white"," "),children:[(0,l.jsx)("div",{className:"whitespace-pre-line break-words",children:t.body}),o&&(0,l.jsx)("div",{className:"text-xs text-grey-500",children:"(\u7de8\u96c6\u6e08\u307f)"})]}),(0,l.jsx)("div",{className:"text-grey-500 text-sm text-right ".concat(n&&"ml-auto"),children:(0,j.N)(t.createdAt)})]})},N=(0,a.memo)(y),k=n(1129),E=function(e){return e.getBoundingClientRect()},M=function(e,t){return{get collidedTop(){return E(e).top<E(t).top},get collidedBottom(){return E(e).bottom>E(t).bottom},get collidedLeft(){return E(e).left<E(t).left},get collidedRight(){return E(e).right>E(t).right},get overflowTop(){return E(t).top-E(e).top},get overflowBottom(){return E(e).bottom-E(t).bottom},get overflowLeft(){return E(t).left-E(e).left},get overflowRight(){return E(e).right-E(t).right}}},I=function(e){var t=e.message,n=e.isMine,o=(0,a.useState)(!1),s=o[0],i=o[1],r=(0,a.useRef)(),d=(0,a.useMemo)((function(){return t.documents}),[t.documents]);return(0,a.useEffect)((function(){var e=document.getElementById(t.id),n=r.current,o=e&&M(e,n);o&&o.collidedRight&&i(!0)}),[t.id]),(0,l.jsxs)("div",{ref:r,className:"w-full",children:[d&&d.map((function(e,o){return(0,l.jsx)(w.Z,{id:t.id,className:"rounded-lg mt-[4px] h-auto p-[20px] ".concat(n?"bg-blue-300 ml-auto":"bg-white"," ").concat(s?"w-auto break-words":"w-max"),children:(0,l.jsx)(k.Z,{file:e})},o)})),(0,l.jsx)("div",{className:"text-grey-500 text-sm text-right ".concat(n&&"ml-auto"," "),children:(0,j.N)(t.createdAt)})]})},Z=(0,a.memo)(I),D=n(7454),B=n.n(D),L=function(e){var t=e.message,n=e.isMine,o=e.onClickPhoto,s=(0,a.useMemo)((function(){return t.photos}),[t.photos]),i=(0,a.useMemo)((function(){if(s){if(1===s.length)return n?"col-start-7 col-span-6":"col-span-6";if(2===s.length)return"col-span-6";if(s.length>=3)return"col-span-4"}return""}),[n,s]);return(0,l.jsxs)("div",{className:"w-full","data-testid":"message-photo",children:[i&&s&&(0,l.jsx)("div",{className:s.length>1?"grid gap-2 lg:grid-cols-12 md:grid-cols-8 sm:grid-cols-4":"grid",children:s.map((function(e,t){return(0,l.jsx)("div",{className:"cursor-pointer ".concat(i),onClick:function(){return o(e.id)},"data-testid":"message-photo-check-onclick",children:(0,l.jsx)(B(),{alt:"",src:e.url,width:200,height:200,className:"w-[200px] h-[200px] object-cover object-center"})},t)}))}),(0,l.jsx)("div",{"data-testid":"message-photo-check-is-mine",className:"text-grey-500 text-sm text-right ".concat(n&&"ml-auto"),children:(0,j.N)(t.createdAt)})]})},S=(0,a.memo)(L),P=n(5814),_=n(7539),V=n(3206),T=n(8033),A=n(6436),F=n(9936),R=n(3731),O=n(8842),H=function(e){var t,n,o,i,r=e.message,c=e.onClickPhoto,u=e.onEditMessage,m=(0,b.U)(),f=(0,d.I)(),v=(0,s.Z)((0,F.h$)(),1)[0],g=(0,R.K)(),x=g.isShowDots,p=g.handleMouseOver,w=g.handleMouseLeave,j=(0,O.L)(),C=j.isShowBubble,y=j.setIsShowBubble,k=j.handleClick,E=j.handleCloseBubble,M=(0,a.useState)(""),I=M[0],D=M[1],B=(0,a.useMemo)((function(){return"author_owner"===(e=r,t=(null===m||void 0===m?void 0:m.id)||"",e.ownerID?e.ownerID===t?"author_owner":"owner":"user");var e,t}),[r,null===m||void 0===m?void 0:m.id]),L=(0,a.useMemo)((function(){return(null===(e=r)||void 0===e?void 0:e.documents)&&e.documents.length?"document":(null===e||void 0===e?void 0:e.photos)&&e.photos.length?"photo":e.body?"body":"empty";var e}),[r]),H=(0,a.useCallback)((function(){v({variables:{shareID:(null===f||void 0===f?void 0:f.share.id)||"",constructionID:r.constructionID,messageID:r.id},update:function(e){e.evict({id:"Message:".concat(r.id)}),e.gc()},onError:function(e){(0,h.d)(e)}}),E()}),[null===f||void 0===f?void 0:f.share.id,v,E,r.constructionID,r.id]),q=(0,a.useCallback)((function(){u&&u(r),E()}),[E,u,r]),G=(0,a.useCallback)((function(e){var t;r.photos&&(null===(t=r.photos)||void 0===t?void 0:t.length)>0&&c(r.photos,e||I||r.photos[0].id),E()}),[r.photos,c,I,E]),K=(0,a.useRef)(null);return(0,_.O)(K,E),(0,l.jsx)("div",{"data-testid":"message-content",children:(0,l.jsxs)("div",{className:"relative",children:[C&&B&&(0,l.jsx)("div",{ref:K,children:(0,l.jsx)(A.Z,{onBlur:E,onDelete:H,onEdit:"body"===L?q:void 0,onPreviewImage:"photo"===L&&["xs","sm"].includes((0,V.G)())?G:void 0})}),!B&&(0,l.jsx)("div",{className:"mt-8",children:(0,l.jsx)(P.Z,{name:(null===(t=r.owner)||void 0===t?void 0:t.name)||(null===(n=r.user)||void 0===n?void 0:n.name)||"",url:(null===(o=r.owner)||void 0===o?void 0:o.url)||(null===(i=r.user)||void 0===i?void 0:i.url)||""})}),(0,l.jsx)("div",{className:"flex ".concat(B&&"justify-end"),children:(0,l.jsxs)("div",{className:"max-w-[80%] md:max-w-[60%] mt-2 flex items-center ".concat(B&&"flex-row-reverse"),onMouseOver:p,onMouseLeave:w,onClick:function(e){return k(e)},children:["body"===L?(0,l.jsx)(N,{message:r,isMine:B}):"document"===L?(0,l.jsx)(Z,{message:r,isMine:B}):"photo"===L?(0,l.jsx)(S,{message:r,isMine:B,onClickPhoto:["xs","sm"].includes((0,V.G)())&&B?D:G}):(0,l.jsx)(l.Fragment,{}),(0,l.jsx)("div",{className:B&&x&&!["xs","sm"].includes((0,V.G)())?"block cursor-pointer":"hidden",onClick:function(e){return function(e){e.preventDefault(),y(!0)}(e)},children:(0,l.jsx)(T.Z,{})})]})})]})})},q=(0,a.memo)(H),G=function(e){var t=e.messages,n=e.onClickPhoto,o=e.onEditMessage;return(0,l.jsx)(l.Fragment,{children:t.map((function(e,t){return(0,l.jsx)(q,{message:e,onClickPhoto:n,onEditMessage:o},t)}))})},K=(0,a.memo)(G),z=n(7328),U=n(6670),X=n(2578),Y=n(3955),$=n(2838),J=n(5573),Q=n(8932),W=n(7015),ee=function(){return(0,l.jsxs)("svg",{width:"24",height:"24",viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg",children:[(0,l.jsx)("path",{d:"M12 10C10.374 10 9 11.374 9 13C9 14.626 10.374 16 12 16C13.626 16 15 14.626 15 13C15 11.374 13.626 10 12 10Z",fill:"#868B90"}),(0,l.jsx)("path",{d:"M20 6H17.414L14.707 3.293C14.52 3.105 14.266 3 14 3H10C9.734 3 9.48 3.105 9.293 3.293L6.586 6H4C2.897 6 2 6.897 2 8V19C2 20.103 2.897 21 4 21H20C21.103 21 22 20.103 22 19V8C22 6.897 21.103 6 20 6ZM12 18C9.29 18 7 15.71 7 13C7 10.29 9.29 8 12 8C14.71 8 17 10.29 17 13C17 15.71 14.71 18 12 18Z",fill:"#868B90"})]})},te=(0,a.memo)(ee),ne=n(6387),oe=function(e){var t=e.setIsLoading,n=e.refetch,i=(0,s.Z)((0,W.F)(),2)[1],c=(0,s.Z)((0,F.og)(),1)[0],u=(0,s.Z)((0,F.ao)(),1)[0],m=(0,d.I)(),f=(0,a.useCallback)((function(e,s){(0,$.Z)(e,Array)&&e.length>30?Q.Am.error("30\u679a\u307e\u3067\u9078\u629e\u3059\u308b\u3053\u3068\u304c\u3067\u304d\u307e\u3059"):(t(!0),(0,$.Z)(e,Array)&&e.length>0&&c({variables:{filenames:e.map((function(e){var t;return null===(t=e.file)||void 0===t?void 0:t.name}))},onCompleted:function(i){var l=i.createPresignedUrls.temporaries;l&&l.forEach(function(){var i=(0,o.Z)(r().mark((function o(i,a){return r().wrap((function(o){for(;;)switch(o.prev=o.next){case 0:return o.next=2,J.Z.put(i.url,e[a].file,{headers:{"Content-Type":"application/octet-stream"}}).catch((function(e){Q.Am.error(e.message)}));case 2:l.length-1===a&&u({variables:{shareID:(null===m||void 0===m?void 0:m.share.id)||"",constructionID:(null===m||void 0===m?void 0:m.id)||"",body:"",photos:"photos"===s?l.map((function(e){return e.temporaryID})):[],documents:"documents"===s?l.map((function(e){return e.temporaryID})):[]},onCompleted:function(){n(),t(!1)},onError:function(e){(0,h.d)(e),t(!1)}});case 3:case"end":return o.stop()}}),o)})));return function(e,t){return i.apply(this,arguments)}}())}}))}),[u,c,null===m||void 0===m?void 0:m.id,null===m||void 0===m?void 0:m.share.id,n,t]);return(0,l.jsx)("div",{className:"mr-2","data-testid":"message-file-input",children:(0,l.jsxs)("div",{className:"flex items-center ",children:[(0,l.jsx)("button",{className:"mr-2 bg-transparent",onClick:function(){i({accept:"image/*",multiple:!0},(function(e){return f(e,"photos")}))},children:(0,l.jsx)(te,{})}),(0,l.jsx)("button",{className:"mr-2 bg-transparent",onClick:function(){i({accept:".doc, .docx, .xls, .xlsx, .ppt, .pptx, .pdf, .txt",multiple:!0},(function(e){return f(e,"documents")}))},children:(0,l.jsx)(ne.Z,{})})]})})},se=(0,a.memo)(oe),ie=n(4066),re=n(9303),le=n(733),ae=function(){var e=(0,V.G)(),t=document.getElementById("page-wraper");t&&["xs","sm"].includes(e)&&(t.style.position="static",setTimeout((function(){t.style.position="fixed"}),500))},de=n(6651),ce=n(6582),ue=function(e){var t=e.refetch,n=e.isEditingMessageMode,o=e.messageEditingContent,i=e.onExitEditingMode,r=(0,d.I)(),c=(0,Y.cI)({defaultValues:{message:""},mode:"onChange",reValidateMode:"onChange"}),u=c.formState,m=u.isDirty,f=u.isValid,v=c.register,g=c.handleSubmit,x=c.resetField,p=c.setValue,b=c.getValues,w=(0,a.useState)(!1),j=w[0],C=w[1],y=(0,s.Z)((0,F.ao)(),1)[0],N=(0,s.Z)((0,F.Ut)(),1)[0];(0,a.useEffect)((function(){p("message",(null===o||void 0===o?void 0:o.body)||"")}),[null===o||void 0===o?void 0:o.body,p]);var k=function(e){e.message&&""!==e.message.trim()&&(n?n&&N({variables:{shareID:(null===r||void 0===r?void 0:r.share.id)||"",constructionID:(null===r||void 0===r?void 0:r.id)||"",messageID:(null===o||void 0===o?void 0:o.id)||"",body:e.message.trim()},update:function(e,t){var n=t.data;e.modify({id:"Message:".concat(null===n||void 0===n?void 0:n.updateMessage.id),fields:{body:function(){return null===n||void 0===n?void 0:n.updateMessage.body},updatedAt:function(){return null===n||void 0===n?void 0:n.updateMessage.updatedAt}}})},onCompleted:function(){x("message"),i()},onError:function(e){(0,h.d)(e)}}):y({variables:{shareID:(null===r||void 0===r?void 0:r.share.id)||"",constructionID:(null===r||void 0===r?void 0:r.id)||"",body:e.message.trim()},onCompleted:function(){t(),x("message")},onError:function(e){(0,h.d)(e)}}))};return(0,l.jsxs)("div",{children:[n?(0,l.jsxs)("div",{className:"border-b-[1px] border-b-grey-200 mb-2 flex justify-between items-center",children:[(0,l.jsx)("div",{className:"flex-none w-[20px]",children:(0,l.jsx)(ie.Z,{color:"grey"})}),(0,l.jsxs)("div",{className:"ml-2 grow",children:[(0,l.jsx)("div",{className:"text-xs text-grey-700",children:"\u7de8\u96c6"}),(0,l.jsx)("div",{className:"text-grey-400",style:{wordBreak:"break-word"},children:null===o||void 0===o?void 0:o.body})]}),(0,l.jsx)("div",{className:"flex-none w-[20px] cursor-pointer","data-testid":"exit-edit-message-btn",onClick:i,children:(0,l.jsx)(re.Z,{color:"grey"})})]}):(0,l.jsx)(l.Fragment,{}),(0,l.jsxs)("div",{className:"flex items-center",children:[n?(0,l.jsx)(l.Fragment,{}):j?(0,l.jsx)("div",{className:"mr-2",children:(0,l.jsx)(le.Z,{size:24,fill:"#C5C6C8"})}):(0,l.jsx)(se,{setIsLoading:C,refetch:t}),(0,l.jsx)(de.Z,(0,U.Z)((0,z.Z)({id:"message"},v("message",{validate:{edited:function(e){return!((null===o||void 0===o?void 0:o.body)&&e===(null===o||void 0===o?void 0:o.body))||"Is Not Change"},required:function(e){return""!==e.trim()||"Is empty"}}})),{name:"message",placeholder:"\u30e1\u30c3\u30bb\u30fc\u30b8\u3092\u5165\u529b",onEnter:ce.tq?function(){var e=document.getElementById("message"),t=b().message;if(p("message",t+"\n"),e&&e.selectionStart){var n=e.selectionStart-1,o=b().message.substr(0,n);p("message",o)}}:g(k),isDisableEnter:j,disabled:j,onBlur:ae,className:"bg-grey-200 rounded-3xl w-full py-3 px-4 text-grey-900 focus:bg-white focus:outline-red-500 resize-none grow"})),(0,l.jsx)("button",{className:"ml-2 bg-transparent",onClick:g(k),disabled:j||!m||!f,children:(0,l.jsx)(X.Z,{fill:!j&&m&&f?void 0:"#C5C6C8"})})]})]})},me=(0,a.memo)(ue),fe=n(3906),he=n(5632),ve=function(){var e,t=(0,d.I)(),n=(0,a.useState)(!1),i=n[0],b=n[1],w=(0,a.useState)(),j=w[0],C=w[1],y=(0,a.useState)(""),N=y[0],k=y[1],E=(0,v.X)(),M=(0,g.T)(),I=function(){var e=(0,x.qY)(),t=document.getElementById("page-wraper");t&&e&&("hidden"===t.style.backfaceVisibility?t.style.backfaceVisibility="visible":t.style.backfaceVisibility="hidden")},Z=function(){var e=(0,a.useRef)(),t=(0,a.useState)(!1),n=t[0],o=t[1],s=function(){e.current.scrollTop>-200&&o(!1),e.current.scrollTop<=-200&&o(!0)};return(0,a.useEffect)((function(){var t=e.current;if(t)return t.addEventListener("scroll",s),function(){return t.removeEventListener("scroll",s)}})),{pos:n,ref:e,handleBottom:function(){e.current.scrollTop=e.current.scrollHeight,o(!1)},handleScroll:s}}(),D=Z.pos,B=Z.ref,L=Z.handleBottom,S=Z.handleScroll,P=(0,he.useRouter)();console.log("mrouter",P),(0,a.useEffect)((function(){!E([fe.P.messageList])&&M.length&&k("\u30a2\u30af\u30bb\u30b9\u3059\u308b\u6a29\u9650\u304c\u3042\u308a\u307e\u305b\u3093\u3002- per")}),[E,M]);var _=(0,F.Kq)({variables:{shareID:(null===t||void 0===t?void 0:t.share.id)||"",constructionID:(null===t||void 0===t?void 0:t.id)||"",offset:0,limit:6},skip:!t||!E([fe.P.messageList]),notifyOnNetworkStatusChange:!0,onError:function(e){(0,h.d)(e)}}),V=_.loading,T=_.fetchMore,A=_.refetch,R=_.data,O=(0,s.Z)((0,f.G)(),2),H=O[0],q=O[1],G=q.selectedImageIndex,z=q.openModal,U=q.closeModal,X=null===R||void 0===R||null===(e=R.listMessages)||void 0===e?void 0:e.messages;return V&&!X?(0,l.jsx)(u.Z,{}):(0,l.jsxs)(l.Fragment,{children:[X?(0,l.jsxs)("div",{className:"flex flex-col grow overflow-hidden",children:[V&&(0,l.jsx)("div",{className:"my-4",children:(0,l.jsx)(u.Z,{})}),(0,l.jsx)("div",{onScroll:function(){I(),S()},ref:B,className:"p-2 md:p-6 flex flex-col-reverse grow overflow-y-scroll scroll-smooth",children:X.length?(0,l.jsxs)(l.Fragment,{children:[(0,l.jsx)(K,{messages:X,onClickPhoto:function(e,t){z({images:e||[],selectedPhotoId:t})},onEditMessage:function(e){C(e),b(!0)}}),(0,l.jsx)(m.Z,{selectedItem:G,images:H.images,isShow:H.isShow,closeModal:U}),(0,l.jsx)(c.df,{onChange:function(){var e=(0,o.Z)(r().mark((function e(n){var o;return r().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(o=X.length||0,!n){e.next=4;break}return e.next=4,T({variables:{shareID:null===t||void 0===t?void 0:t.share.id,constructionID:null===t||void 0===t?void 0:t.id,offset:o,limit:6}});case 4:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()})]}):(0,l.jsx)("div",{className:"text-grey-400 flex justify-center items-center h-full",children:"\u30e1\u30c3\u30bb\u30fc\u30b8\u304c\u3042\u308a\u307e\u305b\u3093\u3002"})}),E([fe.P.messageCreate])&&(0,l.jsx)("div",{className:"w-screen basis-14 md:basis-0 md:w-auto flex-shrink-0",children:(0,l.jsx)("div",{className:"px-4 py-2 md:px-8 md:py-4 bg-white w-full fixed bottom-12 md:static md:bottom-0",children:(0,l.jsx)(me,{refetch:A,isEditingMessageMode:i,onExitEditingMode:function(){b(!1),C(void 0)},messageEditingContent:j})})})]}):(0,l.jsx)("div",{className:" h-auto grow px-6 overflow-y-scroll overflow-x-hidden",children:(0,l.jsx)("div",{className:"text-grey-400 flex justify-center items-center h-full",children:N})}),(0,l.jsx)(p.Z,{fontSize:"large",className:"fixed bottom-28 left-1/2 text-grey-500 cursor-pointer -translate-x-4 ".concat(D?"block":"hidden"),onClick:L})]})},ge=(0,a.memo)(ve)},917:function(e,t,n){"use strict";n.d(t,{t:function(){return s}});var o=n(2838),s=function(){(0,o.Z)(document.activeElement,HTMLElement)&&document.activeElement.blur()}}},function(e){e.O(0,[963,235,652,582,887,417,918,774,888,179],(function(){return t=721,e(e.s=t);var t}));var t=e.O();_N_E=t}]);